name: Build OpenWrt Config

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 检出当前仓库
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史以便创建标签

    # 克隆 OpenWrt 源码
    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout master  # 或指定版本，如 v23.05.3

    # 安装依赖
    - name: Install dependencies
      run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget

    # 设置 OpenWrt 环境
    - name: Setup OpenWrt environment
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 运行 make defconfig
    - name: Generate .config
      run: |
        cd openwrt
        make defconfig
        mv .config openwrt-config-$(date +%Y%m%d).config

    # 上传 .config 文件到 Artifacts
    - name: Upload .config as artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-config
        path: openwrt/openwrt-config-*.config

    # 创建 Git 标签并推送
    - name: Create and push Git tag
      run: |
        TAG_NAME="config-$(date +%Y%m%d)"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "$TAG_NAME" -m "Auto-generated tag for OpenWrt config $TAG_NAME"
        git push origin "$TAG_NAME"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 创建 Release 并上传 .config
    - name: Create Release and Upload Config
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push'
      with:
        tag_name: config-${{ steps.date.outputs.date }}
        name: OpenWrt Config ${{ steps.date.outputs.date }}
        body: Auto-generated OpenWrt .config file
        files: openwrt/openwrt-config-*.config
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # 定义日期输出
      id: date
      run: echo "::set-output name=date::$(date +%Y%m%d)"
